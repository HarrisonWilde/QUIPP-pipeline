#!/usr/bin/env Rscript

library(jsonlite)
library(synthpop)
source("util.R")

main <- function() {
    args <- commandArgs()

    parameter_json = args[0]
    data_path_prefix = args[1]
    output_prefix = args[2]

    p <- read_json(parameter_json)
    params = p$parameters

    data_full <- read.csv(data_path_prefix + ".csv", header=TRUE)

    if (params$num_samples_to_fit == -1) {
        N <- nrows(data_full)
    } else {
        N <- params$num_samples_to_fit
    }

    data_synth <- syn(data = data_full, 
                      visit.sequence = params$vars_sequence,
                      method = params$synthesis_methods,
                      #rules = rules,
                      #rvalues = rule_values,
                      m = 1,
                      k = params$num_samples_to_fit,
                      seed = params$random_state,
                      proper = params$proper,
                      ctree.minbucket = params$tree_minbucket,
                      smoothing = params$smoothing)

    write.csv(data_synth, file=output_prefix + 'synthetic_data.csv')

}
